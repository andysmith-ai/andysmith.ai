#!/bin/bash
# Convert ASCII art to PNG image using pango-view
#
# Usage:
#   ascii2png output.png < input.txt
#   ascii2png -bg "#1a1a2e" -fg "#e0e0e0" output.png < input.txt
#   cat art.txt | ascii2png -fs 28 output.png
#
# Options:
#   -bg COLOR    Background color (default: #1a1a2e)
#   -fg COLOR    Foreground/text color (default: #e0e0e0)
#   -fs SIZE     Font size (default: 28)
#   -m  MARGIN   Margin in pixels (default: 160)
#   -ar RATIO    Minimum aspect ratio width:height (default: 2, meaning 2:1)

bg="#1a1a2e"
fg="#e0e0e0"
fs=28
margin=160
min_ar=2
output=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -bg) bg="$2"; shift 2 ;;
        -fg) fg="$2"; shift 2 ;;
        -fs) fs="$2"; shift 2 ;;
        -m)  margin="$2"; shift 2 ;;
        -ar) min_ar="$2"; shift 2 ;;
        *) output="$1"; shift ;;
    esac
done

if [[ -z "$output" ]]; then
    echo "Usage: ascii2png [options] output.png" >&2
    exit 1
fi

tmp=$(mktemp)
cat > "$tmp"
pango-view --font="DejaVu Sans Mono $fs" --background="$bg" --foreground="$fg" --margin="$margin" -qo "$output" "$tmp"
rm "$tmp"

# Ensure minimum aspect ratio (default 2:1 for Twitter)
read w h < <(identify -format "%w %h" "$output")
target_w=$((h * min_ar))
if (( target_w > w )); then
    convert "$output" -gravity center -background "$bg" -extent "${target_w}x${h}" "$output"
fi
